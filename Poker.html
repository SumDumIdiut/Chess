<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Poker Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a3a, #2d1b69, #4c1d95, #5b21b6);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s ease-out;
        }

        .header h1 {
            font-size: 3em;
            color: #8b5cf6;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .menu-screen {
            background: rgba(30, 27, 75, 0.4);
            border-radius: 20px;
            padding: 40px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 92, 246, 0.3);
            animation: fadeIn 1s ease-out;
        }

        .game-modes {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .mode-btn {
            padding: 20px 40px;
            font-size: 1.3em;
            background: linear-gradient(145deg, #3b82f6, #8b5cf6);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
            font-weight: bold;
        }

        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 24px rgba(139, 92, 246, 0.4);
            background: linear-gradient(145deg, #8b5cf6, #3b82f6);
        }

        .online-setup {
            display: none;
            background: rgba(30, 27, 75, 0.5);
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #8b5cf6;
            font-size: 1.1em;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            border: 2px solid #8b5cf6;
            border-radius: 8px;
            background: rgba(30, 27, 75, 0.7);
            color: white;
            outline: none;
        }

        .lobby-screen {
            display: none;
            animation: fadeIn 0.8s ease-out;
        }

        .lobby-container {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
            min-height: 500px;
        }

        .lobby-panel {
            background: rgba(30, 27, 75, 0.4);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .lobby-panel h3 {
            color: #8b5cf6;
            margin-bottom: 15px;
            font-size: 1.3em;
            text-align: center;
        }

        .players-list {
            list-style: none;
        }

        .player-item {
            background: rgba(59, 130, 246, 0.2);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-item.host {
            background: rgba(139, 92, 246, 0.3);
            border-color: #8b5cf6;
        }

        .player-status {
            font-size: 0.9em;
            color: #a855f7;
        }

        .room-info {
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 20px;
        }

        .room-code {
            font-size: 2em;
            color: #8b5cf6;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .game-variant {
            font-size: 1.2em;
            color: #a855f7;
        }

        .variant-selector {
            margin: 20px 0;
        }

        .variant-selector select {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            border: 2px solid #8b5cf6;
            border-radius: 8px;
            background: rgba(30, 27, 75, 0.7);
            color: white;
            outline: none;
        }

        /* NEW: Add bot button style */
        .add-bot-btn {
            padding: 15px;
            font-size: 1em;
            background: linear-gradient(145deg, #f59e0b, #f97316);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
            font-weight: bold;
            margin-top: 15px;
            width: 100%;
        }

        .add-bot-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(245, 158, 11, 0.4);
        }

        .host-controls {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 15px;
        }

        .start-game-btn {
            padding: 20px;
            font-size: 1.4em;
            background: linear-gradient(145deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
            font-weight: bold;
        }

        .start-game-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 24px rgba(16, 185, 129, 0.4);
        }

        .start-game-btn:disabled {
            background: linear-gradient(145deg, #6b7280, #4b5563);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .lobby-message {
            text-align: center;
            padding: 15px;
            background: rgba(30, 27, 75, 0.5);
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #8b5cf6;
        }

        .copy-code-btn {
            padding: 10px 15px;
            background: #7c3aed;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .copy-code-btn:hover {
            background: #6d28d9;
        }

        .game-screen {
            display: none;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(30, 27, 75, 0.5);
            border-radius: 10px;
        }

        .poker-table {
            background: radial-gradient(ellipse, #2563eb, #1e40af);
            border: 8px solid #4c1d95;
            border-radius: 200px;
            padding: 40px;
            margin: 20px auto;
            min-height: 400px;
            position: relative;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }

        .community-cards {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .card {
            width: 60px;
            height: 84px;
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 0.9em;
            padding: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card.red {
            color: #e74c3c;
        }

        .card.black {
            color: #2c3e50;
        }

        .card.back {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            color: white;
            justify-content: center;
        }

        .players {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .player {
            background: rgba(30, 27, 75, 0.7);
            border: 2px solid #8b5cf6;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            min-width: 150px;
            margin: 5px;
        }

        .player.active {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
        }

        .player.folded {
            opacity: 0.5;
            border-color: #6b7280;
        }

        .player-cards {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 10px 0;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 12px 24px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .control-btn.fold {
            background: #7c3aed;
            color: white;
        }

        .control-btn.call {
            background: #3b82f6;
            color: white;
        }

        .control-btn.raise {
            background: #8b5cf6;
            color: white;
        }

        .control-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .bet-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .bet-input input {
            padding: 8px;
            border: 2px solid #8b5cf6;
            border-radius: 5px;
            background: rgba(30, 27, 75, 0.7);
            color: white;
            width: 100px;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: #7c3aed;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-message {
            text-align: center;
            padding: 15px;
            background: rgba(30, 27, 75, 0.7);
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #8b5cf6;
        }

        @media (max-width: 1024px) {
            .lobby-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .lobby-panel {
                min-height: auto;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .game-modes {
                flex-direction: column;
                align-items: center;
            }
            
            .mode-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .players {
                flex-direction: column;
                gap: 10px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .control-btn {
                width: 100%;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Ultimate Poker</h1>
        </div>

        <!-- Menu Screen -->
        <div id="menuScreen" class="menu-screen">
            <div class="game-modes">
                <button class="mode-btn" onclick="startOfflineGame()">Play Offline</button>
                <button class="mode-btn" onclick="showOnlineSetup()">Play Online</button>
            </div>

            <div id="onlineSetup" class="online-setup">
                <div class="input-group">
                    <label for="playerName">Your Name</label>
                    <input type="text" id="playerName" placeholder="Enter your name">
                </div>
                <div class="input-group">
                    <label for="roomCode">Room Code (leave blank to create)</label>
                    <input type="text" id="roomCode" placeholder="Enter room code">
                </div>
                <button class="mode-btn" onclick="joinOrCreateLobby()">Join / Create Lobby</button>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobbyScreen" class="lobby-screen">
            <div class="lobby-container">
                <div class="lobby-panel">
                    <h3>Players</h3>
                    <ul id="playersList" class="players-list"></ul>
                </div>
                <div class="lobby-panel room-info">
                    <div>
                        <h3 class="room-code-header">Room Code</h3>
                        <div class="room-code" id="lobbyRoomCode"></div>
                        <button class="copy-code-btn" onclick="copyRoomCode()">Copy Code</button>
                    </div>
                    <div class="game-variant" id="lobbyGameVariant"></div>
                </div>
                <div class="lobby-panel host-controls">
                    <h3>Host Controls</h3>
                    <div class="variant-selector">
                        <label for="variantSelect">Game Variant</label>
                        <select id="variantSelect" onchange="onVariantChanged(this.value)">
                            <option value="texas-holdem">Texas Hold'em</option>
                            <option value="omaha">Omaha</option>
                            <option value="five-card-draw">Five Card Draw</option>
                        </select>
                    </div>
                    <button class="add-bot-btn" onclick="addBot()">Add Bot</button>
                    <button id="startGameBtn" class="start-game-btn" onclick="startOnlineGame()">Start Game</button>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="game-screen">
            <button class="back-btn" onclick="backToMenu()">← Back to Menu</button>

            <div class="game-info">
                <div>
                    <strong>Game:</strong> <span id="currentVariant">Texas Hold'em</span>
                </div>
                <div>
                    <strong>Pot:</strong> $<span id="potAmount">0</span>
                </div>
                <div>
                    <strong>Current Bet:</strong> $<span id="currentBet">0</span>
                </div>
            </div>

            <div class="status-message" id="statusMessage">
                Welcome to Ultimate Poker! The first hand will begin shortly.
            </div>

            <div class="poker-table">
                <div class="community-cards" id="communityCards">
                    <!-- Community cards will be added here -->
                </div>
            </div>

            <div class="players" id="playersContainer">
                <!-- Players will be added here -->
            </div>

            <div class="controls">
                <button class="control-btn fold" onclick="playerAction('fold')" id="foldBtn" style="display: none;">Fold</button>
                <button class="control-btn call" onclick="playerAction('call')" id="callBtn" style="display: none;">Call</button>
                <button class="control-btn raise" onclick="playerAction('raise')" id="raiseBtn" style="display: none;">Raise</button>
                
                <div class="bet-input">
                    <label>Bet: $</label>
                    <input type="number" id="betAmount" min="0" value="10">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            variant: 'texas-holdem',
            mode: 'offline',
            players: [],
            currentPlayer: 0,
            pot: 0,
            currentBet: 0,
            communityCards: [],
            deck: [],
            gamePhase: 'preflop', // can be 'preflop', 'flop', 'turn', 'river', 'showdown'
            currentStreet: 0, // 0=preflop, 1=flop, 2=turn, 3=river
            gameActive: false,
            dealerPosition: -1, // Start at -1 so first hand is player 0
            smallBlind: 5,
            bigBlind: 10,
            lastRaiser: null
        };

        // Card deck
        const suits = ['♠', '♥', '♦', '♣'];
        const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];

        function createDeck() {
            const deck = [];
            for (let suit of suits) {
                for (let rank of ranks) {
                    deck.push({
                        rank: rank,
                        suit: suit,
                        color: (suit === '♥' || suit === '♦') ? 'red' : 'black'
                    });
                }
            }
            return shuffleDeck(deck);
        }

        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        function createCard(card, faceDown = false) {
            const cardElement = document.createElement('div');
            cardElement.className = `card ${faceDown ? 'back' : card.color}`;
            
            if (faceDown) {
                cardElement.innerHTML = '🂠';
            } else {
                cardElement.innerHTML = `
                    <div>${card.rank}</div>
                    <div style="font-size: 1.5em;">${card.suit}</div>
                    <div style="transform: rotate(180deg);">${card.rank}</div>
                `;
            }
            
            return cardElement;
        }


        function showOnlineSetup() {
            document.getElementById('onlineSetup').style.display = 'block';
        }

        function joinOrCreateLobby() {
            // Placeholder for online functionality
            const playerName = document.getElementById('playerName').value;
            if (!playerName) {
                alert('Please enter your name.');
                return;
            }
            
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('lobbyScreen').style.display = 'block';
            
            // Mock lobby state
            const lobbyRoomCode = document.getElementById('roomCode').value || 'ABCD';
            document.getElementById('lobbyRoomCode').textContent = lobbyRoomCode;
            document.getElementById('playersList').innerHTML = `<li class="player-item host"><span>${playerName} (Host)</span><span class="player-status">Ready</span></li>`;
        }

        function copyRoomCode() {
            const roomCode = document.getElementById('lobbyRoomCode').textContent;
            navigator.clipboard.writeText(roomCode).then(() => {
                alert('Room code copied to clipboard!');
            });
        }

        function addBot() {
            // Placeholder
            const botName = `Bot ${Math.floor(Math.random() * 100)}`;
            const playerItem = document.createElement('li');
            playerItem.className = 'player-item';
            playerItem.innerHTML = `<span>${botName}</span><span class="player-status">Ready</span>`;
            document.getElementById('playersList').appendChild(playerItem);
        }

        function onVariantChanged(variant) {
            gameState.variant = variant;
            document.getElementById('lobbyGameVariant').textContent = `Variant: ${variant}`;
        }

        function startOnlineGame() {
            // This would normally be triggered by the host via server
            document.getElementById('lobbyScreen').style.display = 'none';
            // For demo, we'll just start an offline-style game
            startOfflineGame();
        }

        function startOfflineGame() {
            gameState.mode = 'offline';
            
            // Always add some bots in offline mode
            gameState.players = [{
                name: 'You',
                chips: 1000,
                cards: [],
                bet: 0,
                isHuman: true,
                isActive: true,
                hasFolded: false
            }];
            
            // Add AI players
            const aiNames = ['Alice', 'Bob', 'Charlie', 'Diana'];
            for (let i = 0; i < 3; i++) {
                gameState.players.push({
                    name: aiNames[i],
                    chips: 1000,
                    cards: [],
                    bet: 0,
                    isHuman: false,
                    isActive: true,
                    hasFolded: false
                });
            }
            
            initializeGame();
            startGame();
        }

        function initializeGame() {
            gameState.deck = createDeck();
            gameState.pot = 0;
            gameState.currentBet = 0;
            gameState.communityCards = [];
            gameState.gamePhase = 'preflop';
            gameState.currentPlayer = 0;
            gameState.gameActive = false;

            // Reset all players
            gameState.players.forEach(player => {
                player.cards = [];
                player.bet = 0;
                player.hasFolded = false;
            });

            // Update UI
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('currentVariant').textContent = 'Texas Hold\'em';
            
            updateGameUI();
        }

        function startGame() {
            gameState.gameActive = true;
            updateStatusMessage('Dealing cards...');
            dealNewHand();
        }

        function dealNewHand() {
            if (!gameState.gameActive) return;

            // Move dealer button
            gameState.dealerPosition = (gameState.dealerPosition + 1) % gameState.players.length;

            // Reset for new hand
            gameState.communityCards = [];
            gameState.deck = createDeck();
            gameState.pot = 0;
            gameState.currentBet = gameState.bigBlind;
            gameState.currentStreet = 0; // Preflop
            gameState.lastRaiser = null;

            // Reset players and deal cards
            gameState.players.forEach(player => {
                player.cards = [];
                player.bet = 0;
                player.hasFolded = false;
                player.hasActed = false; // Track if player has acted in the current round
                
                let cardsToDeal = 2; // Texas Hold'em
                for (let i = 0; i < cardsToDeal; i++) {
                    player.cards.push(gameState.deck.pop() || {rank: '?', suit: '?', color: 'black'});
                }
            });

            // Post blinds
            const sbIndex = (gameState.dealerPosition + 1) % gameState.players.length;
            const bbIndex = (gameState.dealerPosition + 2) % gameState.players.length;
            
            const smallBlindPlayer = gameState.players[sbIndex];
            smallBlindPlayer.bet = Math.min(gameState.smallBlind, smallBlindPlayer.chips);
            smallBlindPlayer.chips -= smallBlindPlayer.bet;
            
            const bigBlindPlayer = gameState.players[bbIndex];
            bigBlindPlayer.bet = Math.min(gameState.bigBlind, bigBlindPlayer.chips);
            bigBlindPlayer.chips -= bigBlindPlayer.bet;

            gameState.pot = smallBlindPlayer.bet + bigBlindPlayer.bet;
            
            // Set first player to act (UTG)
            gameState.currentPlayer = (bbIndex + 1) % gameState.players.length;
            gameState.lastRaiser = bbIndex; // The big blind is the initial "raiser"

            updateGameUI();
            updateStatusMessage(`New hand! Blinds are posted. It's ${gameState.players[gameState.currentPlayer].name}'s turn.`);
            showPlayerActions();
        }

        function dealCommunityCards() {
            const fallbackCard = {rank: '?', suit: '?', color: 'black'};
            if (gameState.currentStreet === 1) {
                // Deal flop (3 cards)
                gameState.communityCards.push(gameState.deck.pop() || fallbackCard);
                gameState.communityCards.push(gameState.deck.pop() || fallbackCard);
                gameState.communityCards.push(gameState.deck.pop() || fallbackCard);
            } else if (gameState.currentStreet >= 2) {
                // Deal turn (1 card) or river (1 card)
                gameState.communityCards.push(gameState.deck.pop() || fallbackCard);
            }
            updateGameUI();
        }

        function startBettingRound() {
            gameState.currentBet = 0;
            gameState.lastRaiser = null;
            gameState.players.forEach(p => {
                if (!p.hasFolded) {
                    p.bet = 0;
                    p.hasActed = false;
                }
            });

            // First player to act post-flop is left of dealer
            gameState.currentPlayer = (gameState.dealerPosition + 1) % gameState.players.length;
            while(gameState.players[gameState.currentPlayer].hasFolded) {
                gameState.currentPlayer = (gameState.currentPlayer + 1) % gameState.players.length;
            }

            updateGameUI();
            showPlayerActions();
        }

        function onBettingRoundComplete() {
            // Collect bets into the pot
            gameState.players.forEach(p => {
                // This logic was flawed, pot is now updated with each action.
                // We just reset their round bet here.
                p.bet = 0;
            });

            if (gameState.currentStreet < 3) {
                gameState.currentStreet++;
                dealCommunityCards();
                startBettingRound();
            } else {
                endHandShowdown();
            }
        }

        function showPlayerActions() {
            const currentPlayer = gameState.players[gameState.currentPlayer];
            document.getElementById('foldBtn').style.display = 'inline-block';
            document.getElementById('callBtn').style.display = 'inline-block';
            document.getElementById('raiseBtn').style.display = 'inline-block';
            
            // If it's AI player's turn
            if (!currentPlayer.isHuman) {
                setTimeout(() => aiPlayerAction(currentPlayer), 1500);
            }
        }

        function aiPlayerAction(player) {
            // Simple AI logic for demonstration
            const actions = ['fold', 'call'];
            if (gameState.currentBet === 0) {
                actions.push('raise');
            }
            
            const action = actions[Math.floor(Math.random() * actions.length)];
            playerAction(action);
        }

        function playerAction(action) {
            const currentPlayer = gameState.players[gameState.currentPlayer];
            if (!currentPlayer) return;
            currentPlayer.hasActed = true;

            if (action === 'fold') {
                currentPlayer.hasFolded = true;
                updateStatusMessage(`${currentPlayer.name} folded.`);
            } else if (action === 'call') {
                const amountToCall = gameState.currentBet - currentPlayer.bet;
                if (amountToCall > 0) {
                    const betAmount = Math.min(amountToCall, currentPlayer.chips);
                    currentPlayer.chips -= betAmount;
                    currentPlayer.bet += betAmount;
                    gameState.pot += betAmount;
                    updateStatusMessage(`${currentPlayer.name} called $${betAmount}.`);
                } else {
                    updateStatusMessage(`${currentPlayer.name} checks.`);
                }
            } else if (action === 'raise') {
                const raiseAmount = parseInt(document.getElementById('betAmount').value);
                const amountToCall = gameState.currentBet - currentPlayer.bet;
                const totalBet = amountToCall + raiseAmount;

                if (totalBet > currentPlayer.chips) {
                    alert('You cannot bet more than your available chips!');
                    return;
                }
                if (raiseAmount < gameState.bigBlind) {
                    alert(`Minimum raise is ${gameState.bigBlind}`);
                    return;
                }

                currentPlayer.chips -= totalBet;
                currentPlayer.bet += totalBet;
                gameState.pot += totalBet;
                gameState.currentBet = currentPlayer.bet;
                gameState.lastRaiser = gameState.currentPlayer;
                updateStatusMessage(`${currentPlayer.name} raised to $${gameState.currentBet}.`);
            }
            
            // Check for winner by fold
            const activePlayers = gameState.players.filter(p => !p.hasFolded);
            if (activePlayers.length === 1) {
                const winner = activePlayers[0];
                winner.chips += gameState.pot;
                updateStatusMessage(`${winner.name} wins $${gameState.pot} as everyone else folded!`);
                updateGameUI(true);
                setTimeout(dealNewHand, 4000);
                return;
            }

            // Determine next player
            let nextPlayerIndex = (gameState.currentPlayer + 1) % gameState.players.length;
            while (gameState.players[nextPlayerIndex].hasFolded) {
                nextPlayerIndex = (nextPlayerIndex + 1) % gameState.players.length;
            }

            // Check if betting round is complete
            const allActivePlayersActed = activePlayers.every(p => p.hasActed);
            const allBetsMatched = activePlayers.every(p => p.bet === gameState.currentBet);

            if (allActivePlayersActed && allBetsMatched) {
                onBettingRoundComplete();
            } else {
                gameState.currentPlayer = nextPlayerIndex;
                updateGameUI();
                showPlayerActions();
            }
        }

        function endHandShowdown() {
            updateStatusMessage('Showdown! Revealing cards...');
            updateGameUI(true); // Show all cards

            const activePlayers = gameState.players.filter(p => !p.hasFolded);
            if (activePlayers.length > 0) {
                // For now, a real hand evaluation is complex. We'll just pick a random winner.
                const winner = activePlayers[Math.floor(Math.random() * activePlayers.length)];
                winner.chips += gameState.pot;
                updateStatusMessage(`${winner.name} wins the pot of $${gameState.pot}! A new hand will start shortly.`);
            } else {
                updateStatusMessage('No winners in showdown. A new hand will start shortly.');
            }

            gameState.pot = 0;

            // Prepare for next hand
            setTimeout(dealNewHand, 5000); // Start new hand after 5 seconds
        }

        function updateGameUI(showAllCards = false) {
            // Update community cards
            const communityCardsContainer = document.getElementById('communityCards');
            communityCardsContainer.innerHTML = '';
            gameState.communityCards.forEach(card => {
                communityCardsContainer.appendChild(createCard(card));
            });

            // Update players display
            const playersContainer = document.getElementById('playersContainer');
            playersContainer.innerHTML = '';
            gameState.players.forEach((player, index) => {
                const playerElement = document.createElement('div');
                playerElement.className = `player ${player.hasFolded ? 'folded' : ''} ${index === gameState.currentPlayer ? 'active' : ''}`;
                playerElement.innerHTML = `
                    <strong>${player.name}</strong><br>
                    Chips: $${player.chips}<br>
                    Bet: $${player.bet}<br>
                `;
                
                // Show player's cards (face down for other players)
                if (player.cards.length > 0) {
                    const cardsDiv = document.createElement('div');
                    cardsDiv.className = 'player-cards';
                    const faceDown = !player.isHuman && !showAllCards;
                    player.cards.forEach(card => {
                        cardsDiv.appendChild(createCard(card, faceDown));
                    });
                    playerElement.appendChild(cardsDiv);
                }
                
                playersContainer.appendChild(playerElement);
            });

            // Update pot and current bet
            document.getElementById('potAmount').textContent = gameState.pot;
            document.getElementById('currentBet').textContent = gameState.currentBet;
        }

        function updateStatusMessage(message) {
            document.getElementById('statusMessage').textContent = message;
        }

        function backToMenu() {
            // This function is now used to exit a game and return to the main menu.
            // A simple page reload is the easiest way to reset the state.
            window.location.reload();
        }

        // The game no longer starts automatically. The user must click the "Play Offline" button.
        document.addEventListener('DOMContentLoaded', () => {
            // The script is now much simpler and should not have issues loading.
        });
    </script>
</body>
</html>